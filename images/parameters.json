{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "location": {
        "value": "westeurope"
      },
      "tags": {
        "value": {
          "project": "fd-avd"
        }
      },
      "resourceGroupNames": {
        "value": {
          "images": "rg-images"
        }
      },
      "roleDefinitions": {
        "value": {
          "imageBuilderRole": {
            "name": "Image Builder (Custom)",
            "description": "This role will allow Image Builder to read/write images, read in scripts from Azure Storage",
            "actions": [
              "Microsoft.Compute/galleries/read",
              "Microsoft.Compute/galleries/images/read",
              "Microsoft.Compute/galleries/images/versions/read",
              "Microsoft.Compute/galleries/images/versions/write",
              "Microsoft.Compute/images/read",
              "Microsoft.Compute/images/write",
              "Microsoft.Compute/images/delete",
              "Microsoft.VirtualMachineImages/imageTemplates/run/action"
            ]
          },
          "avdDeploymentScriptRole": {
            "name": "Deployment Script for AVD Images (Custom)",
            "description": "This role will allow Deployment Script Managed Identity to ",
            "actions": [
              "Microsoft.Storage/storageAccounts/blobServices/containers/read",
              "Microsoft.Storage/storageAccounts/blobServices/containers/write",
              "Microsoft.ContainerInstance/containerGroups/read",
              "Microsoft.ContainerInstance/containerGroups/write",
              "Microsoft.ContainerInstance/containerGroups/start/action",
              "Microsoft.Resources/deployments/read",
              "Microsoft.Resources/deploymentScripts/read",
              "Microsoft.Resources/deploymentScripts/write"
            ]
          }
        }
      },
      "galleryProperties": {
        "value": {
          "name": "gallery",
          "softDelete": false
        }
      },
      "imagesInfo": {
        "value": {
          "wvd10-pers": {
            "imageDefinitionProperties": {
              "name": "WVD10_Pers_Definition",
              "offer": "Windows-10",
              "publisher": "MicrosoftWindowsDesktop",
              "sku": "20h1-ent",
              "vmGeneration": "V1"        
            },
            "imageTemplateProperties": {
              "name": "WVD10-Pers-Template",
              "source" : {
                "type": "PlatformImage",
                "publisher": "MicrosoftWindowsDesktop",
                "offer": "windows-10",
                "sku": "20h1-ent",
                "version": "latest"
              },
              "customize": [
                {
                  "type": "PowerShell",
                  "name": "installFsLogix",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/0_installConfFsLogix.ps1"
                },
                {
                  "type": "PowerShell",
                  "name": "OptimizeOS",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/1_Optimize_OS_for_WVD.ps1"
                },
                {
                  "type": "WindowsRestart",
                  "restartCheckCommand": "write-host 'restarting post Optimizations'",
                  "restartTimeout": "5m"
                },
                {
                  "type": "PowerShell",
                  "name": "Install Teams",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/2_installTeams.ps1"
                },
                {
                  "type": "WindowsRestart",
                  "restartCheckCommand": "write-host 'restarting post Teams Install'",
                  "restartTimeout": "5m"
                },
                {
                  "type": "WindowsUpdate",
                  "searchCriteria": "IsInstalled=0",
                  "filters": [
                    "exclude:$_.Title -like '*Preview*'",
                    "include:$true"
                  ],
                  "updateLimit": 40
                }
              ],
              "runOutputName": "WVD10-Pers-CustomImage",
              "artifactTags": {
                "sourceimage": "wvd-10",
                "baseosimage": "windows-10"
              },
              "replicationRegions": [
                "westeurope",
                "northeurope"
              ]
            }
          },
          "wvd10-pool": {
            "imageDefinitionProperties": {
              "name": "WVD10_Pool_Definition",
              "offer": "Windows-10",
              "publisher": "MicrosoftWindowsDesktop",
              "sku": "20h2-evd",
              "vmGeneration": "V1"        
            },
            "imageTemplateProperties": {
              "name": "WVD10-Pool-Template",
              "source" : {
                "type": "PlatformImage",
                "publisher": "MicrosoftWindowsDesktop",
                "offer": "windows-10",
                "sku": "20h2-evd",
                "version": "latest"
              },
              "customize": [
                {
                  "type": "PowerShell",
                  "name": "installFsLogix",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/0_installConfFsLogix.ps1"
                },
                {
                  "type": "PowerShell",
                  "name": "OptimizeOS",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/1_Optimize_OS_for_WVD.ps1"
                },
                {
                  "type": "WindowsRestart",
                  "restartCheckCommand": "write-host 'restarting post Optimizations'",
                  "restartTimeout": "5m"
                },
                {
                  "type": "PowerShell",
                  "name": "Install Teams",
                  "runElevated": true,
                  "runAsSystem": true,
                  "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/2_installTeams.ps1"
                },
                {
                  "type": "WindowsRestart",
                  "restartCheckCommand": "write-host 'restarting post Teams Install'",
                  "restartTimeout": "5m"
                },
                {
                  "type": "WindowsUpdate",
                  "searchCriteria": "IsInstalled=0",
                  "filters": [
                    "exclude:$_.Title -like '*Preview*'",
                    "include:$true"
                  ],
                  "updateLimit": 40
                }
              ],
              "runOutputName": "WVD10-Pool-CustomImage",
              "artifactTags": {
                "sourceimage": "wvd-10",
                "baseosimage": "windows-10"
              },
              "replicationRegions": [
                "westeurope",
                "northeurope"
              ]
            }
          }
        }  
      }   
  }
}